<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.chart.*?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>

<BorderPane xmlns="http://javafx.com/javafx/17" xmlns:fx="http://javafx.com/fxml/1"
            fx:controller="com.ensah.qoe.Controller.PredictionDashboardController"
            stylesheets="@../css/dashboard.css">

    <!-- Header -->
    <top>
        <VBox spacing="10" styleClass="header-section">
            <padding>
                <Insets top="15" right="20" bottom="15" left="20"/>
            </padding>

            <HBox alignment="CENTER_LEFT" spacing="15">
                <Button fx:id="backBtn" text="â† Retour" onAction="#goBack" styleClass="btn-back"/>
                <Label text="Dashboard de PrÃ©diction QoE" styleClass="header-title"/>
                <Region HBox.hgrow="ALWAYS"/>
                <Label fx:id="statusLabel" text="PrÃªt" styleClass="status-label"/>
                <Button fx:id="refreshBtn" text="ðŸ”„ Actualiser" onAction="#refreshData" styleClass="btn-refresh"/>
            </HBox>
        </VBox>
    </top>

    <!-- Content -->
    <center>
        <TabPane tabClosingPolicy="UNAVAILABLE" styleClass="main-tabs">
            <padding>
                <Insets top="10" right="10" bottom="10" left="10"/>
            </padding>

            <!-- ============ TAB 1: VISUALISATION ============ -->
            <Tab text="ðŸ“Š Visualisation">
                <ScrollPane fitToWidth="true" fitToHeight="true">
                    <VBox spacing="15">
                        <padding>
                            <Insets top="15" right="15" bottom="15" left="15"/>
                        </padding>

                        <!-- MÃ©triques globales -->
                        <HBox spacing="20" alignment="CENTER_LEFT">
                            <VBox spacing="5" styleClass="metric-card" HBox.hgrow="ALWAYS">
                                <Label text="MOS Moyen" styleClass="metric-label"/>
                                <Label fx:id="avgMOSLabel" text="--" styleClass="metric-value"/>
                            </VBox>

                            <VBox spacing="5" styleClass="metric-card" HBox.hgrow="ALWAYS">
                                <Label text="PrÃ©cision" styleClass="metric-label"/>
                                <Label fx:id="accuracyLabel" text="--" styleClass="metric-value"/>
                            </VBox>

                            <VBox spacing="5" styleClass="metric-card" HBox.hgrow="ALWAYS">
                                <Label text="QualitÃ© Globale" styleClass="metric-label"/>
                                <ProgressBar fx:id="overallQualityBar" progress="0" prefWidth="200" styleClass="quality-progress"/>
                            </VBox>
                        </HBox>

                        <!-- ContrÃ´les des graphiques -->
                        <HBox spacing="15" alignment="CENTER_LEFT" styleClass="controls-section">
                            <Label text="Type de graphique:"/>
                            <ComboBox fx:id="chartTypeCombo" prefWidth="150"/>

                            <Region HBox.hgrow="ALWAYS"/>

                            <Label text="Instances:"/>
                            <Slider fx:id="instancesSlider" prefWidth="200"/>

                            <CheckBox fx:id="showRealCheck" text="RÃ©el" selected="true"/>
                            <CheckBox fx:id="showPredCheck" text="PrÃ©dit" selected="true"/>

                            <Button fx:id="updateChartBtn" text="Mettre Ã  jour" onAction="#updateCharts" styleClass="btn-primary"/>
                        </HBox>

                        <!-- Graphiques -->
                        <SplitPane dividerPositions="0.6" prefHeight="400">
                            <VBox spacing="5">
                                <Label text="Ã‰volution des PrÃ©dictions" styleClass="chart-title"/>
                                <LineChart fx:id="predictionChart" VBox.vgrow="ALWAYS" legendVisible="true">
                                    <xAxis>
                                        <CategoryAxis label="Instance" side="BOTTOM"/>
                                    </xAxis>
                                    <yAxis>
                                        <NumberAxis label="MOS" side="LEFT" lowerBound="1" upperBound="5" tickUnit="0.5"/>
                                    </yAxis>
                                </LineChart>
                            </VBox>

                            <VBox spacing="5">
                                <Label text="Distribution des QualitÃ©s" styleClass="chart-title"/>
                                <BarChart fx:id="distributionChart" VBox.vgrow="ALWAYS" legendVisible="false">
                                    <xAxis>
                                        <CategoryAxis label="CatÃ©gorie" side="BOTTOM"/>
                                    </xAxis>
                                    <yAxis>
                                        <NumberAxis label="Nombre" side="LEFT"/>
                                    </yAxis>
                                </BarChart>
                            </VBox>
                        </SplitPane>

                        <!-- MÃ©triques dÃ©taillÃ©es -->
                        <VBox spacing="5">
                            <HBox alignment="CENTER_LEFT" spacing="10">
                                <Label text="MÃ©triques du ModÃ¨le" styleClass="section-title"/>
                                <Region HBox.hgrow="ALWAYS"/>
                                <Button fx:id="exportCSVBtn" text="ðŸ’¾ CSV" styleClass="btn-export"/>
                                <Button fx:id="exportPDFBtn" text="ðŸ“„ PDF" styleClass="btn-export"/>
                                <Button fx:id="exportImageBtn" text="ðŸ–¼ï¸ Image" styleClass="btn-export"/>
                            </HBox>
                            <TableView fx:id="metricsTable" prefHeight="150" styleClass="metrics-table"/>
                        </VBox>
                    </VBox>
                </ScrollPane>
            </Tab>

            <!-- ============ TAB 2: PRÃ‰DICTION MANUELLE ============ -->
            <Tab text="ðŸŽ¯ PrÃ©diction Manuelle">
                <ScrollPane fitToWidth="true" fitToHeight="true">
                    <VBox spacing="20">
                        <padding>
                            <Insets top="15" right="15" bottom="15" left="15"/>
                        </padding>

                        <HBox spacing="20">
                            <!-- Formulaire de saisie -->
                            <VBox spacing="15" styleClass="input-section" HBox.hgrow="ALWAYS">
                                <Label text="ParamÃ¨tres RÃ©seau" styleClass="section-title"/>

                                <VBox spacing="8">
                                    <Label text="Latence (ms)"/>
                                    <HBox spacing="10" alignment="CENTER_LEFT">
                                        <Slider fx:id="latenceSlider" HBox.hgrow="ALWAYS"/>
                                        <TextField fx:id="latenceField" prefWidth="80" promptText="50.0"/>
                                    </HBox>
                                </VBox>

                                <VBox spacing="8">
                                    <Label text="Jitter (ms)"/>
                                    <HBox spacing="10" alignment="CENTER_LEFT">
                                        <Slider fx:id="jitterSlider" HBox.hgrow="ALWAYS"/>
                                        <TextField fx:id="jitterField" prefWidth="80" promptText="10.0"/>
                                    </HBox>
                                </VBox>

                                <VBox spacing="8">
                                    <Label text="Perte de Paquets (%)"/>
                                    <HBox spacing="10" alignment="CENTER_LEFT">
                                        <Slider fx:id="perteSlider" HBox.hgrow="ALWAYS"/>
                                        <TextField fx:id="perteField" prefWidth="80" promptText="1.0"/>
                                    </HBox>
                                </VBox>

                                <VBox spacing="8">
                                    <Label text="Bande Passante (Mbps)"/>
                                    <HBox spacing="10" alignment="CENTER_LEFT">
                                        <Slider fx:id="bandePassanteSlider" HBox.hgrow="ALWAYS"/>
                                        <TextField fx:id="bandePassanteField" prefWidth="80" promptText="50.0"/>
                                    </HBox>
                                </VBox>

                                <VBox spacing="8">
                                    <Label text="Force du Signal (%)"/>
                                    <HBox spacing="10" alignment="CENTER_LEFT">
                                        <Slider fx:id="signalSlider" HBox.hgrow="ALWAYS"/>
                                        <TextField fx:id="signalField" prefWidth="80" promptText="80.0"/>
                                    </HBox>
                                </VBox>

                                <HBox spacing="10" alignment="CENTER">
                                    <Button fx:id="predictSingleBtn" text="ðŸŽ¯ PrÃ©dire" onAction="#predictSingle" styleClass="btn-primary"/>
                                    <Button fx:id="clearFormBtn" text="ðŸ—‘ï¸ Effacer" onAction="#clearForm" styleClass="btn-secondary"/>
                                    <Button fx:id="randomValuesBtn" text="ðŸŽ² Valeurs AlÃ©atoires" onAction="#generateRandomValues" styleClass="btn-secondary"/>
                                </HBox>
                            </VBox>

                            <!-- RÃ©sultat de la prÃ©diction -->
                            <VBox spacing="15" styleClass="result-section" prefWidth="300">
                                <Label text="RÃ©sultat" styleClass="section-title"/>

                                <VBox spacing="10" alignment="CENTER" styleClass="prediction-result">
                                    <Label text="Score MOS" styleClass="result-label"/>
                                    <Label fx:id="singleMOSLabel" text="--" styleClass="mos-value"/>

                                    <Label text="CatÃ©gorie QoE" styleClass="result-label"/>
                                    <Label fx:id="singleCategoryLabel" text="--" styleClass="category-value"/>

                                    <ProgressBar fx:id="singleQualityBar" progress="0" prefWidth="250" styleClass="quality-progress-large"/>
                                </VBox>
                            </VBox>
                        </HBox>

                        <!-- Historique des prÃ©dictions -->
                        <VBox spacing="10">
                            <HBox alignment="CENTER_LEFT" spacing="15">
                                <Label text="Historique des PrÃ©dictions" styleClass="section-title"/>
                                <Label fx:id="historyCountLabel" text="0 prÃ©dictions" styleClass="count-label"/>
                                <Region HBox.hgrow="ALWAYS"/>
                                <Button fx:id="clearHistoryBtn" text="ðŸ—‘ï¸ Effacer l'historique" onAction="#clearHistory" styleClass="btn-danger"/>
                            </HBox>
                            <TableView fx:id="historyTable" prefHeight="250" styleClass="history-table"/>
                        </VBox>
                    </VBox>
                </ScrollPane>
            </Tab>

            <!-- ============ TAB 3: IMPORT CSV ============ -->
            <Tab text="ðŸ“ Import CSV">
                <ScrollPane fitToWidth="true" fitToHeight="true">
                    <VBox spacing="20">
                        <padding>
                            <Insets top="15" right="15" bottom="15" left="15"/>
                        </padding>

                        <!-- SÃ©lection du fichier -->
                        <VBox spacing="10" styleClass="file-section">
                            <Label text="1. SÃ©lectionner un Fichier CSV" styleClass="section-title"/>

                            <HBox spacing="10" alignment="CENTER_LEFT">
                                <TextField fx:id="filePathField" promptText="Chemin du fichier CSV..." HBox.hgrow="ALWAYS"/>
                                <Button fx:id="browseBtn" text="ðŸ“ Parcourir" onAction="#browseFile" styleClass="btn-primary"/>
                            </HBox>

                            <HBox spacing="20">
                                <CheckBox fx:id="hasHeaderCheck" text="Le fichier contient des en-tÃªtes" selected="true"/>
                                <CheckBox fx:id="autoDetectCheck" text="DÃ©tection automatique des colonnes" selected="true"/>
                            </HBox>

                            <Button fx:id="loadCSVBtn" text="ðŸ“¥ Charger le Fichier" onAction="#loadCSVFile" styleClass="btn-primary" prefWidth="200"/>
                        </VBox>

                        <!-- PrÃ©visualisation -->
                        <VBox spacing="10" fx:id="previewSection">
                            <HBox alignment="CENTER_LEFT" spacing="10">
                                <Label text="2. PrÃ©visualisation des DonnÃ©es" styleClass="section-title"/>
                                <Label fx:id="previewCountLabel" text="0" styleClass="count-label"/>
                                <Label text="lignes chargÃ©es"/>
                            </HBox>
                            <TableView fx:id="previewTable" prefHeight="150" styleClass="preview-table"/>
                        </VBox>

                        <!-- Mapping des colonnes -->
                        <VBox spacing="10" fx:id="mappingBox">
                            <Label text="3. Correspondance des Colonnes" styleClass="section-title"/>
                            <TableView fx:id="columnMappingTable" prefHeight="150" styleClass="mapping-table"/>
                        </VBox>

                        <!-- Actions de prÃ©diction -->
                        <VBox spacing="10">
                            <Label text="4. Lancer les PrÃ©dictions" styleClass="section-title"/>

                            <HBox spacing="10" alignment="CENTER_LEFT">
                                <Button fx:id="predictBatchBtn" text="ðŸš€ PrÃ©dire Tout" onAction="#predictBatch" styleClass="btn-success"/>
                                <Button fx:id="samplePredictBtn" text="ðŸ” PrÃ©diction Ã‰chantillon" styleClass="btn-primary"/>
                                <Button fx:id="clearBatchBtn" text="ðŸ—‘ï¸ Effacer RÃ©sultats" styleClass="btn-secondary"/>
                            </HBox>
                        </VBox>

                        <!-- RÃ©sultats batch -->
                        <VBox spacing="10">
                            <Label text="RÃ©sultats des PrÃ©dictions" styleClass="section-title"/>

                            <!-- Statistiques -->
                            <HBox spacing="20">
                                <VBox spacing="5" styleClass="stat-card">
                                    <Label text="Total PrÃ©dictions"/>
                                    <Label fx:id="totalPredictionsLabel" text="0" styleClass="stat-value"/>
                                </VBox>

                                <VBox spacing="5" styleClass="stat-card">
                                    <Label text="MOS Moyen"/>
                                    <Label fx:id="batchAvgMOSLabel" text="--" styleClass="stat-value"/>
                                </VBox>

                                <VBox spacing="5" styleClass="stat-card">
                                    <Label text="Excellent"/>
                                    <Label fx:id="excellentCountLabel" text="0" styleClass="stat-value-success"/>
                                </VBox>

                                <VBox spacing="5" styleClass="stat-card">
                                    <Label text="Mauvais"/>
                                    <Label fx:id="badCountLabel" text="0" styleClass="stat-value-danger"/>
                                </VBox>
                            </HBox>

                            <!-- Distribution -->
                            <GridPane hgap="10" vgap="5">
                                <Label text="Excellent" GridPane.columnIndex="0" GridPane.rowIndex="0"/>
                                <ProgressBar fx:id="excellentBar" progress="0" prefWidth="200" GridPane.columnIndex="1" GridPane.rowIndex="0" styleClass="dist-excellent"/>

                                <Label text="Bon" GridPane.columnIndex="0" GridPane.rowIndex="1"/>
                                <ProgressBar fx:id="goodBar" progress="0" prefWidth="200" GridPane.columnIndex="1" GridPane.rowIndex="1" styleClass="dist-good"/>

                                <Label text="Moyen" GridPane.columnIndex="0" GridPane.rowIndex="2"/>
                                <ProgressBar fx:id="averageBar" progress="0" prefWidth="200" GridPane.columnIndex="1" GridPane.rowIndex="2" styleClass="dist-average"/>

                                <Label text="MÃ©diocre" GridPane.columnIndex="0" GridPane.rowIndex="3"/>
                                <ProgressBar fx:id="mediumBar" progress="0" prefWidth="200" GridPane.columnIndex="1" GridPane.rowIndex="3" styleClass="dist-medium"/>

                                <Label text="Mauvais" GridPane.columnIndex="0" GridPane.rowIndex="4"/>
                                <ProgressBar fx:id="badBar" progress="0" prefWidth="200" GridPane.columnIndex="1" GridPane.rowIndex="4" styleClass="dist-bad"/>
                            </GridPane>

                            <!-- Table des rÃ©sultats -->
                            <TableView fx:id="batchResultsTable" prefHeight="250" styleClass="results-table"/>

                            <!-- Actions d'export -->
                            <HBox spacing="10" alignment="CENTER_LEFT">
                                <Button fx:id="exportBatchCSVBtn" text="ðŸ’¾ Exporter CSV" styleClass="btn-export"/>
                                <Button fx:id="exportBatchPDFBtn" text="ðŸ“„ Exporter PDF" styleClass="btn-export"/>
                                <Button fx:id="saveToDBBtn" text="ðŸ’¿ Sauvegarder en BD" styleClass="btn-primary"/>
                            </HBox>
                        </VBox>
                    </VBox>
                </ScrollPane>
            </Tab>
        </TabPane>
    </center>

    <!-- Footer -->
    <bottom>
        <HBox spacing="20" alignment="CENTER_LEFT" styleClass="footer-section">
            <padding>
                <Insets top="10" right="20" bottom="10" left="20"/>
            </padding>

            <Label fx:id="modelStatusLabel" text="ModÃ¨le: Non chargÃ©" styleClass="footer-label"/>
            <Separator orientation="VERTICAL"/>
            <Label fx:id="dataStatsLabel" text="DonnÃ©es: 0 instances" styleClass="footer-label"/>
            <Region HBox.hgrow="ALWAYS"/>
            <Label fx:id="lastUpdateLabel" text="DerniÃ¨re mise Ã  jour: --" styleClass="footer-label"/>
        </HBox>
    </bottom>

</BorderPane>