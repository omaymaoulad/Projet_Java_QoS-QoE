<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import javafx.scene.chart.*?>
<?import javafx.scene.text.*?>

<BorderPane xmlns="http://javafx.com/javafx/17" xmlns:fx="http://javafx.com/fxml/1"
            fx:controller="com.ensah.qoe.Controller.MLDashboardController"
            stylesheets="@../css/ml-dashboard.css">

    <!-- HEADER -->
    <top>
        <VBox styleClass="header-container">
            <HBox alignment="CENTER_LEFT" spacing="20" styleClass="header-main">
                <Label text="ðŸ¤– QoE Machine Learning Dashboard" styleClass="header-title"/>
                <Region HBox.hgrow="ALWAYS"/>
                <Label fx:id="statusLabel" text="Initialisation..." styleClass="status-label"/>
                <Button text="ðŸ”„ Actualiser" onAction="#refreshData" styleClass="btn-refresh"/>
                <Button text="â† Retour" onAction="#goBack" styleClass="btn-back"/>
            </HBox>

            <!-- Stats Cards -->
            <HBox spacing="15" styleClass="stats-container">
                <VBox styleClass="stat-card">
                    <Label text="Dataset" styleClass="stat-label"/>
                    <Label fx:id="datasetSizeLabel" text="0" styleClass="stat-value"/>
                    <Label text="instances" styleClass="stat-unit"/>
                </VBox>

                <VBox styleClass="stat-card">
                    <Label text="ModÃ¨le" styleClass="stat-label"/>
                    <Label fx:id="modelTypeLabel" text="-" styleClass="stat-value"/>
                    <Label text="algorithme" styleClass="stat-unit"/>
                </VBox>

                <VBox styleClass="stat-card">
                    <Label text="PrÃ©cision" styleClass="stat-label"/>
                    <Label fx:id="accuracyLabel" text="0.00" styleClass="stat-value"/>
                    <Label text="RÂ² score" styleClass="stat-unit"/>
                </VBox>

                <VBox styleClass="stat-card">
                    <Label text="PrÃ©dictions" styleClass="stat-label"/>
                    <Label fx:id="predictionsCountLabel" text="0" styleClass="stat-value"/>
                    <Label text="effectuÃ©es" styleClass="stat-unit"/>
                </VBox>
            </HBox>
        </VBox>
    </top>

    <!-- MAIN CONTENT -->
    <center>
        <TabPane tabClosingPolicy="UNAVAILABLE" styleClass="main-tabs">

            <!-- TAB 1: VUE D'ENSEMBLE -->
            <Tab text="ðŸ“Š Vue d'ensemble">
                <ScrollPane fitToWidth="true" fitToHeight="true">
                    <VBox spacing="20" styleClass="content-container">

                        <!-- Performance Metrics -->
                        <VBox styleClass="section-card">
                            <Label text="ðŸ“ˆ MÃ©triques de Performance" styleClass="section-title"/>
                            <HBox spacing="20" alignment="CENTER">
                                <LineChart fx:id="performanceChart"
                                           title="Ã‰volution des Performances"
                                           prefHeight="250" prefWidth="500"
                                           styleClass="chart-container">
                                    <xAxis><CategoryAxis label="MÃ©trique"/></xAxis>
                                    <yAxis><NumberAxis label="Score"/></yAxis>
                                </LineChart>

                                <VBox spacing="15" styleClass="metrics-grid">
                                    <HBox spacing="10" styleClass="metric-row">
                                        <Label text="MAE:" styleClass="metric-label"/>
                                        <Label fx:id="maeLabel" text="0.00" styleClass="metric-value"/>
                                    </HBox>
                                    <HBox spacing="10" styleClass="metric-row">
                                        <Label text="RMSE:" styleClass="metric-label"/>
                                        <Label fx:id="rmseLabel" text="0.00" styleClass="metric-value"/>
                                    </HBox>
                                    <HBox spacing="10" styleClass="metric-row">
                                        <Label text="RÂ²:" styleClass="metric-label"/>
                                        <Label fx:id="r2Label" text="0.00" styleClass="metric-value"/>
                                    </HBox>
                                    <HBox spacing="10" styleClass="metric-row">
                                        <Label text="CorrÃ©lation:" styleClass="metric-label"/>
                                        <Label fx:id="correlationLabel" text="0.00" styleClass="metric-value"/>
                                    </HBox>
                                </VBox>
                            </HBox>
                        </VBox>

                        <!-- Recent Predictions Table -->
                        <VBox styleClass="section-card">
                            <Label text="ðŸ”® PrÃ©dictions RÃ©centes" styleClass="section-title"/>
                            <TableView fx:id="recentPredictionsTable"
                                       prefHeight="300"
                                       styleClass="predictions-table"/>
                        </VBox>

                    </VBox>
                </ScrollPane>
            </Tab>

            <!-- TAB 2: ENTRAÃŽNEMENT -->
            <Tab text="ðŸŽ“ EntraÃ®nement">
                <ScrollPane fitToWidth="true" fitToHeight="true">
                    <VBox spacing="20" styleClass="content-container">

                        <!-- Training Configuration -->
                        <VBox styleClass="section-card">
                            <Label text="âš™ï¸ Configuration de l'EntraÃ®nement" styleClass="section-title"/>

                            <GridPane hgap="15" vgap="15" styleClass="config-grid">
                                <Label text="Type de ModÃ¨le:" GridPane.rowIndex="0" GridPane.columnIndex="0" styleClass="label-bold"/>
                                <ComboBox fx:id="modelTypeCombo" prefWidth="250" GridPane.rowIndex="0" GridPane.columnIndex="1"/>

                                <Label text="Validation:" GridPane.rowIndex="1" GridPane.columnIndex="0" styleClass="label-bold"/>
                                <ComboBox fx:id="validationCombo" prefWidth="250" GridPane.rowIndex="1" GridPane.columnIndex="1"/>

                                <Label text="Ratio Train/Test:" GridPane.rowIndex="2" GridPane.columnIndex="0" styleClass="label-bold"/>
                                <HBox spacing="10" alignment="CENTER_LEFT" GridPane.rowIndex="2" GridPane.columnIndex="1">
                                    <Slider fx:id="trainRatioSlider" min="0.5" max="0.95" value="0.8"
                                            showTickLabels="true" showTickMarks="true" prefWidth="200"/>
                                    <Label text="80%" styleClass="slider-value"/>
                                </HBox>
                            </GridPane>

                            <HBox spacing="15" alignment="CENTER" styleClass="button-group">
                                <Button fx:id="trainBtn" text="ðŸš€ EntraÃ®ner le ModÃ¨le"
                                        onAction="#trainModel" styleClass="btn-primary"/>
                                <Button text="ðŸ’¾ Sauvegarder ModÃ¨le" styleClass="btn-secondary"/>
                                <Button text="ðŸ“‚ Charger ModÃ¨le" styleClass="btn-secondary"/>
                            </HBox>
                        </VBox>

                        <!-- Training Progress -->
                        <VBox styleClass="section-card">
                            <Label text="â³ Progression de l'EntraÃ®nement" styleClass="section-title"/>
                            <VBox spacing="10">
                                <HBox spacing="10" alignment="CENTER_LEFT">
                                    <ProgressBar fx:id="trainingProgressBar" prefWidth="500" prefHeight="25"/>
                                    <Label fx:id="trainingProgressLabel" text="En attente..." styleClass="progress-label"/>
                                </HBox>
                            </VBox>
                        </VBox>

                        <!-- Training Results -->
                        <VBox styleClass="section-card">
                            <HBox alignment="CENTER_LEFT" spacing="10">
                                <Label text="ðŸ“„ RÃ©sultats de l'EntraÃ®nement" styleClass="section-title"/>
                                <Region HBox.hgrow="ALWAYS"/>
                                <Button text="ðŸ—‘ï¸ Effacer" onAction="#clearTestOutput" styleClass="btn-small"/>
                                <Button text="ðŸ’¾ Sauvegarder Log" onAction="#saveTestLog" styleClass="btn-small"/>
                            </HBox>
                            <TextArea fx:id="trainingResultsArea"
                                      prefHeight="300"
                                      editable="false"
                                      wrapText="true"
                                      styleClass="console-output"/>
                        </VBox>

                        <!-- Feature Importance -->
                        <VBox styleClass="section-card">
                            <Label text="ðŸŽ¯ Importance des Features" styleClass="section-title"/>
                            <BarChart fx:id="featureImportanceChart"
                                      title="Impact des Variables sur la QualitÃ©"
                                      prefHeight="300"
                                      styleClass="chart-container">
                                <xAxis><CategoryAxis label="Feature"/></xAxis>
                                <yAxis><NumberAxis label="Importance (%)" upperBound="100"/></yAxis>
                            </BarChart>
                        </VBox>

                    </VBox>
                </ScrollPane>
            </Tab>

            <!-- TAB 3: PRÃ‰DICTION -->
            <Tab text="ðŸ”® PrÃ©diction">
                <ScrollPane fitToWidth="true" fitToHeight="true">
                    <VBox spacing="20" styleClass="content-container">

                        <!-- Manual Prediction -->
                        <VBox styleClass="section-card">
                            <Label text="ðŸŽ›ï¸ PrÃ©diction Manuelle" styleClass="section-title"/>

                            <GridPane hgap="20" vgap="15" styleClass="prediction-grid">
                                <!-- Latence -->
                                <Label text="Latence (ms):" GridPane.rowIndex="0" GridPane.columnIndex="0" styleClass="input-label"/>
                                <HBox spacing="10" GridPane.rowIndex="0" GridPane.columnIndex="1">
                                    <Slider fx:id="latenceSlider" prefWidth="300"/>
                                    <TextField fx:id="latenceField" prefWidth="80" styleClass="input-field"/>
                                </HBox>

                                <!-- Jitter -->
                                <Label text="Jitter (ms):" GridPane.rowIndex="1" GridPane.columnIndex="0" styleClass="input-label"/>
                                <HBox spacing="10" GridPane.rowIndex="1" GridPane.columnIndex="1">
                                    <Slider fx:id="jitterSlider" prefWidth="300"/>
                                    <TextField fx:id="jitterField" prefWidth="80" styleClass="input-field"/>
                                </HBox>

                                <!-- Perte -->
                                <Label text="Perte (%):" GridPane.rowIndex="2" GridPane.columnIndex="0" styleClass="input-label"/>
                                <HBox spacing="10" GridPane.rowIndex="2" GridPane.columnIndex="1">
                                    <Slider fx:id="perteSlider" prefWidth="300"/>
                                    <TextField fx:id="perteField" prefWidth="80" styleClass="input-field"/>
                                </HBox>

                                <!-- Bande Passante -->
                                <Label text="Bande Passante (Mbps):" GridPane.rowIndex="3" GridPane.columnIndex="0" styleClass="input-label"/>
                                <HBox spacing="10" GridPane.rowIndex="3" GridPane.columnIndex="1">
                                    <Slider fx:id="bandePassanteSlider" prefWidth="300"/>
                                    <TextField fx:id="bandePassanteField" prefWidth="80" styleClass="input-field"/>
                                </HBox>

                                <!-- Signal -->
                                <Label text="Signal Score:" GridPane.rowIndex="4" GridPane.columnIndex="0" styleClass="input-label"/>
                                <HBox spacing="10" GridPane.rowIndex="4" GridPane.columnIndex="1">
                                    <Slider fx:id="signalSlider" prefWidth="300"/>
                                    <TextField fx:id="signalField" prefWidth="80" styleClass="input-field"/>
                                </HBox>
                            </GridPane>

                            <Button fx:id="predictBtn" text="ðŸ”® PrÃ©dire le MOS"
                                    onAction="#predictManual" styleClass="btn-predict"/>
                        </VBox>

                        <!-- Prediction Result -->
                        <HBox spacing="20" styleClass="result-container">
                            <VBox styleClass="result-card-large" alignment="CENTER">
                                <Label text="MOS PrÃ©dit" styleClass="result-label"/>
                                <Label fx:id="predictedMOSLabel" text="--" styleClass="result-mos"/>
                                <Label fx:id="qoeCategoryLabel" text="En attente" styleClass="result-category"/>
                            </VBox>

                            <VBox styleClass="result-card-large" alignment="CENTER" spacing="10">
                                <Label text="Indicateur de QualitÃ©" styleClass="result-label"/>
                                <ProgressBar fx:id="qualityIndicator"
                                             prefWidth="300" prefHeight="40"
                                             styleClass="quality-bar"/>
                                <HBox spacing="5">
                                    <Label text="Mauvais" styleClass="quality-text-low"/>
                                    <Region HBox.hgrow="ALWAYS"/>
                                    <Label text="Excellent" styleClass="quality-text-high"/>
                                </HBox>
                            </VBox>
                        </HBox>

                        <!-- Prediction History -->
                        <VBox styleClass="section-card">
                            <Label text="ðŸ“œ Historique des PrÃ©dictions" styleClass="section-title"/>
                            <TableView fx:id="predictionHistoryTable"
                                       prefHeight="250"
                                       styleClass="predictions-table"/>
                        </VBox>

                    </VBox>
                </ScrollPane>
            </Tab>

            <!-- TAB 4: TESTS -->
            <Tab text="ðŸ§ª Tests">
                <ScrollPane fitToWidth="true" fitToHeight="true">
                    <VBox spacing="20" styleClass="content-container">

                        <!-- Test Actions -->
                        <VBox styleClass="section-card">
                            <Label text="ðŸŽ® Actions de Test" styleClass="section-title"/>
                            <HBox spacing="15" alignment="CENTER" styleClass="test-buttons">
                                <Button fx:id="quickTestBtn" text="âš¡ Test Rapide"
                                        onAction="#runQuickTest" styleClass="btn-test"/>
                                <Button fx:id="evaluateBtn" text="ðŸ“Š Ã‰valuer ModÃ¨le"
                                        onAction="#evaluateModel" styleClass="btn-test"/>
                                <Button fx:id="predictMissingBtn" text="ðŸ”® PrÃ©dire MOS Manquants"
                                        onAction="#predictMissingMOS" styleClass="btn-test"/>
                                <Button fx:id="fullTestBtn" text="ðŸš€ Suite ComplÃ¨te"
                                        onAction="#runAllTests" styleClass="btn-test-full"/>
                            </HBox>
                        </VBox>

                        <!-- Test Output -->
                        <VBox styleClass="section-card">
                            <HBox alignment="CENTER_LEFT" spacing="10">
                                <Label text="ðŸ’» Console de Sortie" styleClass="section-title"/>
                                <Region HBox.hgrow="ALWAYS"/>
                                <Button text="ðŸ—‘ï¸ Effacer" onAction="#clearTestOutput" styleClass="btn-small"/>
                                <Button text="ðŸ’¾ Exporter" onAction="#saveTestLog" styleClass="btn-small"/>
                            </HBox>
                            <TextArea fx:id="testOutputArea"
                                      prefHeight="400"
                                      editable="false"
                                      wrapText="true"
                                      styleClass="console-output"/>
                        </VBox>

                    </VBox>
                </ScrollPane>
            </Tab>

            <!-- TAB 5: VISUALISATIONS -->
            <Tab text="ðŸ“ˆ Visualisations">
                <ScrollPane fitToWidth="true" fitToHeight="true">
                    <VBox spacing="20" styleClass="content-container">

                        <!-- MOS Distribution -->
                        <VBox styleClass="section-card">
                            <Label text="ðŸ“Š Distribution des Scores MOS" styleClass="section-title"/>
                            <BarChart fx:id="mosDistributionChart"
                                      title="RÃ©partition par CatÃ©gorie QoE"
                                      prefHeight="300"
                                      styleClass="chart-container">
                                <xAxis><CategoryAxis label="CatÃ©gorie"/></xAxis>
                                <yAxis><NumberAxis label="Nombre d'instances"/></yAxis>
                            </BarChart>
                        </VBox>

                        <!-- Scatter Plots -->
                        <HBox spacing="20">
                            <VBox styleClass="section-card" HBox.hgrow="ALWAYS">
                                <Label text="ðŸ“‰ MOS vs Latence" styleClass="section-title"/>
                                <ScatterChart fx:id="mosVsLatenceChart"
                                              prefHeight="300"
                                              styleClass="chart-container">
                                    <xAxis><NumberAxis label="Latence (ms)"/></xAxis>
                                    <yAxis><NumberAxis label="MOS" lowerBound="1" upperBound="5"/></yAxis>
                                </ScatterChart>
                            </VBox>

                            <VBox styleClass="section-card" HBox.hgrow="ALWAYS">
                                <Label text="ðŸ“‰ MOS vs Perte" styleClass="section-title"/>
                                <ScatterChart fx:id="mosVsPerteChart"
                                              prefHeight="300"
                                              styleClass="chart-container">
                                    <xAxis><NumberAxis label="Perte (%)"/></xAxis>
                                    <yAxis><NumberAxis label="MOS" lowerBound="1" upperBound="5"/></yAxis>
                                </ScatterChart>
                            </VBox>
                        </HBox>

                    </VBox>
                </ScrollPane>
            </Tab>

        </TabPane>
    </center>

    <!-- FOOTER -->
    <bottom>
        <HBox styleClass="footer-container" alignment="CENTER_LEFT" spacing="30">
            <Label fx:id="modelInfoLabel" text="ModÃ¨le: Non entraÃ®nÃ©" styleClass="footer-text"/>
            <Separator orientation="VERTICAL"/>
            <Label fx:id="dataInfoLabel" text="DonnÃ©es: 0 instances" styleClass="footer-text"/>
            <Separator orientation="VERTICAL"/>
            <Label fx:id="lastUpdateLabel" text="DerniÃ¨re mise Ã  jour: --" styleClass="footer-text"/>
            <Region HBox.hgrow="ALWAYS"/>
            <Label text="QoE ML System v1.0" styleClass="footer-text-version"/>
        </HBox>
    </bottom>

</BorderPane>