<?xml version="1.0" encoding="UTF-8"?>
<?import javafx.geometry.Insets?>
<?import javafx.scene.chart.*?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import javafx.scene.text.Font?>

<BorderPane xmlns="http://javafx.com/javafx/17"
            xmlns:fx="http://javafx.com/fxml/1"
            fx:controller="com.ensah.qoe.Controller.MLDashboardController"
            style="-fx-background-color: #f8f9fa;">

    <!-- Top: Header avec titre et boutons -->
    <top>
        <VBox spacing="10" style="-fx-background-color: #2c3e50; -fx-padding: 20;">
            <HBox spacing="20" alignment="CENTER_LEFT">
                <Label text="ðŸ§  Dashboard Machine Learning QoE/QoS"
                       style="-fx-text-fill: white; -fx-font-weight: bold;">
                    <font>
                        <Font size="24"/>
                    </font>
                </Label>

                <HBox spacing="10" alignment="CENTER_RIGHT" HBox.hgrow="ALWAYS">
                    <Button fx:id="backBtn" text="â† Retour"
                            style="-fx-background-color: #7f8c8d; -fx-text-fill: white;"
                            onAction="#goBack"/>
                    <Button fx:id="refreshBtn" text="ðŸ”„ Actualiser"
                            style="-fx-background-color: #3498db; -fx-text-fill: white;"
                            onAction="#refreshData"/>
                    <Button fx:id="exportBtn" text="ðŸ“¤ Exporter"
                            style="-fx-background-color: #27ae60; -fx-text-fill: white;"
                            onAction="#exportResults"/>
                </HBox>
            </HBox>

            <Label fx:id="statusLabel" text="PrÃªt"
                   style="-fx-text-fill: #ecf0f1; -fx-font-size: 14;"/>
        </VBox>
    </top>

    <!-- Center: Contenu principal -->
    <center>
        <TabPane tabClosingPolicy="UNAVAILABLE">

            <!-- Tab 1: Vue d'ensemble -->
            <Tab text="ðŸ“Š Vue d'ensemble">
                <ScrollPane fitToWidth="true">
                    <VBox spacing="20" style="-fx-padding: 20;">

                        <!-- Cartes de statistiques -->
                        <GridPane hgap="20" vgap="20">
                            <columnConstraints>
                                <ColumnConstraints prefWidth="200"/>
                                <ColumnConstraints prefWidth="200"/>
                                <ColumnConstraints prefWidth="200"/>
                                <ColumnConstraints prefWidth="200"/>
                            </columnConstraints>

                            <!-- Carte 1 -->
                            <VBox style="-fx-background-color: white; -fx-padding: 20; -fx-border-radius: 8; -fx-effect: dropshadow(three-pass-box, rgba(0,0,0,0.1), 10, 0, 0, 0);"
                                  GridPane.columnIndex="0">
                                <Label text="Dataset" style="-fx-font-weight: bold;"/>
                                <Label fx:id="datasetSizeLabel" text="Chargement..."
                                       style="-fx-font-size: 24; -fx-text-fill: #3498db;"/>
                                <Label text="instances"/>
                            </VBox>

                            <!-- Carte 2 -->
                            <VBox style="-fx-background-color: white; -fx-padding: 20; -fx-border-radius: 8; -fx-effect: dropshadow(three-pass-box, rgba(0,0,0,0.1), 10, 0, 0, 0);"
                                  GridPane.columnIndex="1">
                                <Label text="ModÃ¨le" style="-fx-font-weight: bold;"/>
                                <Label fx:id="modelTypeLabel" text="Chargement..."
                                       style="-fx-font-size: 24; -fx-text-fill: #2ecc71;"/>
                                <Label text="Random Forest"/>
                            </VBox>

                            <!-- Carte 3 -->
                            <VBox style="-fx-background-color: white; -fx-padding: 20; -fx-border-radius: 8; -fx-effect: dropshadow(three-pass-box, rgba(0,0,0,0.1), 10, 0, 0, 0);"
                                  GridPane.columnIndex="2">
                                <Label text="PrÃ©cision" style="-fx-font-weight: bold;"/>
                                <Label fx:id="accuracyLabel" text="Chargement..."
                                       style="-fx-font-size: 24; -fx-text-fill: #e74c3c;"/>
                                <Label text="RÂ² Score"/>
                            </VBox>

                            <!-- Carte 4 -->
                            <VBox style="-fx-background-color: white; -fx-padding: 20; -fx-border-radius: 8; -fx-effect: dropshadow(three-pass-box, rgba(0,0,0,0.1), 10, 0, 0, 0);"
                                  GridPane.columnIndex="3">
                                <Label text="PrÃ©dictions" style="-fx-font-weight: bold;"/>
                                <Label fx:id="predictionsCountLabel" text="Chargement..."
                                       style="-fx-font-size: 24; -fx-text-fill: #9b59b6;"/>
                                <Label text="MOS prÃ©dits"/>
                            </VBox>
                        </GridPane>

                        <!-- Graphiques -->
                        <VBox spacing="10">
                            <Label text="Performance du ModÃ¨le" style="-fx-font-weight: bold; -fx-font-size: 18;"/>
                            <LineChart fx:id="performanceChart" prefHeight="300">
                                <xAxis>
                                    <CategoryAxis label="MÃ©triques"/>
                                </xAxis>
                                <yAxis>
                                    <NumberAxis label="Valeur"/>
                                </yAxis>
                            </LineChart>
                        </VBox>

                        <!-- DerniÃ¨res prÃ©dictions -->
                        <VBox spacing="10">
                            <Label text="ðŸ“‹ DerniÃ¨res PrÃ©dictions" style="-fx-font-weight: bold; -fx-font-size: 18;"/>
                            <TableView fx:id="recentPredictionsTable" prefHeight="200">
                                <columns>
                                    <TableColumn text="ID" prefWidth="60"/>
                                    <TableColumn text="Latence" prefWidth="80"/>
                                    <TableColumn text="Jitter" prefWidth="80"/>
                                    <TableColumn text="Perte" prefWidth="80"/>
                                    <TableColumn text="MOS PrÃ©dit" prefWidth="100"/>
                                    <TableColumn text="CatÃ©gorie" prefWidth="120"/>
                                    <TableColumn text="Date" prefWidth="120"/>
                                </columns>
                            </TableView>
                        </VBox>
                    </VBox>
                </ScrollPane>
            </Tab>

            <!-- Tab 2: EntraÃ®nement du modÃ¨le -->
            <Tab text="ðŸŽ“ EntraÃ®nement">
                <VBox spacing="20" style="-fx-padding: 20;">
                    <Label text="Configuration de l'entraÃ®nement" style="-fx-font-weight: bold; -fx-font-size: 18;"/>

                    <GridPane hgap="15" vgap="15">
                        <columnConstraints>
                            <ColumnConstraints prefWidth="150"/>
                            <ColumnConstraints prefWidth="250"/>
                        </columnConstraints>

                        <Label text="ModÃ¨le:" GridPane.rowIndex="0" GridPane.columnIndex="0"/>
                        <ComboBox fx:id="modelTypeCombo" GridPane.rowIndex="0" GridPane.columnIndex="1"/>

                        <Label text="Ratio Train/Test:" GridPane.rowIndex="1" GridPane.columnIndex="0"/>
                        <Slider fx:id="trainRatioSlider" min="0.5" max="0.9" value="0.8"
                                showTickLabels="true" showTickMarks="true"
                                majorTickUnit="0.1" minorTickCount="0"
                                GridPane.rowIndex="1" GridPane.columnIndex="1"/>

                        <Label text="Validation:" GridPane.rowIndex="2" GridPane.columnIndex="0"/>
                        <ComboBox fx:id="validationCombo" GridPane.rowIndex="2" GridPane.columnIndex="1"/>
                    </GridPane>

                    <HBox spacing="20">
                        <Button fx:id="trainBtn" text="ðŸš€ Lancer l'entraÃ®nement"
                                style="-fx-background-color: #3498db; -fx-text-fill: white; -fx-font-weight: bold; -fx-padding: 10 20;"
                                onAction="#trainModel"/>

                        <ProgressBar fx:id="trainingProgressBar" prefWidth="400"/>
                        <Label fx:id="trainingProgressLabel" text="0%"/>
                    </HBox>

                    <!-- RÃ©sultats d'entraÃ®nement -->
                    <VBox spacing="10">
                        <Label text="ðŸ“Š RÃ©sultats de l'entraÃ®nement" style="-fx-font-weight: bold;"/>
                        <TextArea fx:id="trainingResultsArea" prefHeight="200" editable="false"
                                  style="-fx-font-family: 'Monospaced'; -fx-font-size: 12;"/>
                    </VBox>

                    <!-- Importances des features -->
                    <VBox spacing="10">
                        <Label text="ðŸŽ¯ Importance des Features" style="-fx-font-weight: bold;"/>
                        <BarChart fx:id="featureImportanceChart" prefHeight="200">
                            <xAxis>
                                <CategoryAxis label="Features"/>
                            </xAxis>
                            <yAxis>
                                <NumberAxis label="Importance"/>
                            </yAxis>
                        </BarChart>
                    </VBox>
                </VBox>
            </Tab>

            <!-- Tab 3: PrÃ©diction manuelle -->
            <Tab text="ðŸ”® PrÃ©diction">
                <VBox spacing="20" style="-fx-padding: 20;">
                    <Label text="PrÃ©dire le MOS Ã  partir des paramÃ¨tres QoS"
                           style="-fx-font-weight: bold; -fx-font-size: 18;"/>

                    <GridPane hgap="15" vgap="15">
                        <columnConstraints>
                            <ColumnConstraints prefWidth="150"/>
                            <ColumnConstraints prefWidth="200"/>
                            <ColumnConstraints prefWidth="100"/>
                        </columnConstraints>

                        <!-- ParamÃ¨tres d'entrÃ©e -->
                        <Label text="Latence (ms):" GridPane.rowIndex="0" GridPane.columnIndex="0"/>
                        <TextField fx:id="latenceField" text="50" GridPane.rowIndex="0" GridPane.columnIndex="1"/>
                        <Slider fx:id="latenceSlider" min="0" max="500" value="50"
                                GridPane.rowIndex="0" GridPane.columnIndex="2"/>

                        <Label text="Jitter (ms):" GridPane.rowIndex="1" GridPane.columnIndex="0"/>
                        <TextField fx:id="jitterField" text="10" GridPane.rowIndex="1" GridPane.columnIndex="1"/>
                        <Slider fx:id="jitterSlider" min="0" max="100" value="10"
                                GridPane.rowIndex="1" GridPane.columnIndex="2"/>

                        <Label text="Perte (%):" GridPane.rowIndex="2" GridPane.columnIndex="0"/>
                        <TextField fx:id="perteField" text="1.0" GridPane.rowIndex="2" GridPane.columnIndex="1"/>
                        <Slider fx:id="perteSlider" min="0" max="20" value="1.0"
                                GridPane.rowIndex="2" GridPane.columnIndex="2"/>

                        <Label text="Bande passante (Mbps):" GridPane.rowIndex="3" GridPane.columnIndex="0"/>
                        <TextField fx:id="bandePassanteField" text="50" GridPane.rowIndex="3" GridPane.columnIndex="1"/>
                        <Slider fx:id="bandePassanteSlider" min="1" max="100" value="50"
                                GridPane.rowIndex="3" GridPane.columnIndex="2"/>

                        <Label text="Score signal (%):" GridPane.rowIndex="4" GridPane.columnIndex="0"/>
                        <TextField fx:id="signalField" text="80" GridPane.rowIndex="4" GridPane.columnIndex="1"/>
                        <Slider fx:id="signalSlider" min="0" max="100" value="80"
                                GridPane.rowIndex="4" GridPane.columnIndex="2"/>
                    </GridPane>

                    <!-- Bouton de prÃ©diction -->
                    <Button fx:id="predictBtn" text="ðŸ”® PrÃ©dire le MOS"
                            style="-fx-background-color: #9b59b6; -fx-text-fill: white; -fx-font-weight: bold; -fx-padding: 15 30;"
                            onAction="#predictManual"/>

                    <!-- RÃ©sultat de prÃ©diction -->
                    <VBox spacing="10" style="-fx-background-color: #ecf0f1; -fx-padding: 20; -fx-border-radius: 8;">
                        <Label text="RÃ©sultat de la prÃ©diction" style="-fx-font-weight: bold;"/>

                        <HBox spacing="30" alignment="CENTER">
                            <VBox spacing="5" alignment="CENTER">
                                <Label text="MOS PrÃ©dit"/>
                                <Label fx:id="predictedMOSLabel" text="--"
                                       style="-fx-font-size: 48; -fx-font-weight: bold; -fx-text-fill: #2c3e50;"/>
                            </VBox>

                            <VBox spacing="5" alignment="CENTER">
                                <Label text="CatÃ©gorie QoE"/>
                                <Label fx:id="qoeCategoryLabel" text="--"
                                       style="-fx-font-size: 24; -fx-font-weight: bold; -fx-text-fill: #27ae60;"/>
                            </VBox>
                        </HBox>

                        <!-- Indicateur visuel -->
                        <VBox spacing="5">
                            <Label text="QualitÃ© estimÃ©e:"/>
                            <ProgressBar fx:id="qualityIndicator" prefWidth="600"
                                         style="-fx-accent: #27ae60;"/>
                            <HBox spacing="5">
                                <Label text="Mauvais" style="-fx-text-fill: #e74c3c;"/>
                                <Region HBox.hgrow="ALWAYS"/>
                                <Label text="Excellent" style="-fx-text-fill: #27ae60;"/>
                            </HBox>
                        </VBox>
                    </VBox>

                    <!-- Historique des prÃ©dictions -->
                    <VBox spacing="10">
                        <Label text="ðŸ“‹ Historique des prÃ©dictions" style="-fx-font-weight: bold;"/>
                        <TableView fx:id="predictionHistoryTable" prefHeight="200">
                            <columns>
                                <TableColumn text="Heure"/>
                                <TableColumn text="Latence"/>
                                <TableColumn text="Jitter"/>
                                <TableColumn text="Perte"/>
                                <TableColumn text="MOS"/>
                                <TableColumn text="CatÃ©gorie"/>
                            </columns>
                        </TableView>
                    </VBox>
                </VBox>
            </Tab>

            <!-- Tab 4: Tests et Ã©valuations -->
            <Tab text="ðŸ§ª Tests">
                <VBox spacing="20" style="-fx-padding: 20;">
                    <Label text="Tests et Ã‰valuations du ModÃ¨le"
                           style="-fx-font-weight: bold; -fx-font-size: 18;"/>

                    <!-- Boutons de test -->
                    <HBox spacing="15">
                        <Button fx:id="quickTestBtn" text="ðŸ§ª Test rapide"
                                style="-fx-background-color: #f39c12; -fx-text-fill: white;"
                                onAction="#runQuickTest"/>
                        <Button fx:id="evaluateBtn" text="ðŸ“Š Ã‰valuer"
                                style="-fx-background-color: #16a085; -fx-text-fill: white;"
                                onAction="#evaluateModel"/>
                        <Button fx:id="predictMissingBtn" text="ðŸ”® PrÃ©dire MOS manquants"
                                style="-fx-background-color: #8e44ad; -fx-text-fill: white;"
                                onAction="#predictMissingMOS"/>
                        <Button fx:id="fullTestBtn" text="ðŸš€ Tous les tests"
                                style="-fx-background-color: #e74c3c; -fx-text-fill: white; -fx-font-weight: bold;"
                                onAction="#runAllTests"/>
                    </HBox>

                    <!-- Sortie des tests -->
                    <VBox spacing="10">
                        <Label text="ðŸ“ Sortie des tests" style="-fx-font-weight: bold;"/>
                        <TextArea fx:id="testOutputArea" prefHeight="300" editable="false"
                                  style="-fx-font-family: 'Monospaced'; -fx-font-size: 12;"/>

                        <HBox spacing="10">
                            <Button fx:id="clearTestBtn" text="ðŸ—‘ï¸ Effacer"
                                    onAction="#clearTestOutput"/>
                            <Button fx:id="saveTestBtn" text="ðŸ’¾ Sauvegarder log"
                                    onAction="#saveTestLog"/>
                        </HBox>
                    </VBox>

                    <!-- MÃ©triques de performance -->
                    <VBox spacing="10">
                        <Label text="ðŸ“ˆ MÃ©triques de Performance" style="-fx-font-weight: bold;"/>
                        <GridPane hgap="20" vgap="10">
                            <columnConstraints>
                                <ColumnConstraints prefWidth="150"/>
                                <ColumnConstraints prefWidth="100"/>
                                <ColumnConstraints prefWidth="150"/>
                                <ColumnConstraints prefWidth="100"/>
                            </columnConstraints>

                            <Label text="MAE:" GridPane.rowIndex="0" GridPane.columnIndex="0"/>
                            <Label fx:id="maeLabel" text="--" GridPane.rowIndex="0" GridPane.columnIndex="1"/>

                            <Label text="RMSE:" GridPane.rowIndex="0" GridPane.columnIndex="2"/>
                            <Label fx:id="rmseLabel" text="--" GridPane.rowIndex="0" GridPane.columnIndex="3"/>

                            <Label text="RÂ²:" GridPane.rowIndex="1" GridPane.columnIndex="0"/>
                            <Label fx:id="r2Label" text="--" GridPane.rowIndex="1" GridPane.columnIndex="1"/>

                            <Label text="CorrÃ©lation:" GridPane.rowIndex="1" GridPane.columnIndex="2"/>
                            <Label fx:id="correlationLabel" text="--" GridPane.rowIndex="1" GridPane.columnIndex="3"/>
                        </GridPane>
                    </VBox>
                </VBox>
            </Tab>

            <!-- Tab 5: Visualisation des donnÃ©es -->
            <Tab text="ðŸ“ˆ Visualisation">
                <VBox spacing="20" style="-fx-padding: 20;">
                    <Label text="Visualisation des DonnÃ©es et PrÃ©dictions"
                           style="-fx-font-weight: bold; -fx-font-size: 18;"/>

                    <!-- Graphique de distribution MOS -->
                    <VBox spacing="10">
                        <Label text="Distribution des MOS" style="-fx-font-weight: bold;"/>
                        <BarChart fx:id="mosDistributionChart" prefHeight="250">
                            <xAxis>
                                <CategoryAxis label="CatÃ©gorie MOS"/>
                            </xAxis>
                            <yAxis>
                                <NumberAxis label="Nombre"/>
                            </yAxis>
                        </BarChart>
                    </VBox>

                    <!-- Scatter plot MOS vs Features -->
                    <HBox spacing="20">
                        <VBox spacing="10">
                            <Label text="MOS vs Latence" style="-fx-font-weight: bold;"/>
                            <ScatterChart fx:id="mosVsLatenceChart" prefWidth="350" prefHeight="250">
                                <xAxis>
                                    <NumberAxis label="Latence (ms)"/>
                                </xAxis>
                                <yAxis>
                                    <NumberAxis label="MOS"/>
                                </yAxis>
                            </ScatterChart>
                        </VBox>

                        <VBox spacing="10">
                            <Label text="MOS vs Perte" style="-fx-font-weight: bold;"/>
                            <ScatterChart fx:id="mosVsPerteChart" prefWidth="350" prefHeight="250">
                                <xAxis>
                                    <NumberAxis label="Perte (%)"/>
                                </xAxis>
                                <yAxis>
                                    <NumberAxis label="MOS"/>
                                </yAxis>
                            </ScatterChart>
                        </VBox>
                    </HBox>

                    <!-- Matrice de corrÃ©lation -->
                    <VBox spacing="10">
                        <Label text="ðŸ“Š Matrice de CorrÃ©lation" style="-fx-font-weight: bold;"/>
                        <TableView fx:id="correlationMatrixTable" prefHeight="200">
                            <columns>
                                <TableColumn text="Feature"/>
                                <TableColumn text="Latence"/>
                                <TableColumn text="Jitter"/>
                                <TableColumn text="Perte"/>
                                <TableColumn text="Bande passante"/>
                                <TableColumn text="Signal"/>
                                <TableColumn text="MOS"/>
                            </columns>
                        </TableView>
                    </VBox>
                </VBox>
            </Tab>
        </TabPane>
    </center>

    <!-- Bottom: Footer -->
    <bottom>
        <HBox spacing="20" alignment="CENTER" style="-fx-background-color: #ecf0f1; -fx-padding: 10;">
            <Label fx:id="modelInfoLabel" text="ModÃ¨le: Non entraÃ®nÃ©"/>
            <Separator orientation="VERTICAL"/>
            <Label fx:id="dataInfoLabel" text="DonnÃ©es: Chargement..."/>
            <Separator orientation="VERTICAL"/>
            <Label fx:id="lastUpdateLabel" text="DerniÃ¨re mise Ã  jour: --"/>
        </HBox>
    </bottom>

</BorderPane>